<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>–ê–¥–º–∏–Ω–∫–∞</title>
    <style>
        :root {
            --green: #2e7d32;
            --bg: #f9f9f9;
            --text: #333;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
        }
        .header {
            background: var(--green);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #eee;
        }
        .tab-btn {
            padding: 14px 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: #555;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active {
            color: var(--green);
            border-bottom: 3px solid var(--green);
            font-weight: bold;
        }
        .tab-content {
            display: none;
            padding: 24px;
            background: white;
            min-height: 500px;
        }
        .tab-content.active {
            display: block;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è CRUD (–∫–∞–∫ —Ä–∞–Ω—å—à–µ) */
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f0f0f0;
        }
        .btn {
            padding: 8px 16px;
            background: var(--green);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 8px;
        }
        .btn-danger {
            background: #f44336;
        }
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        #universalCrudModal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        #universalCrudModal > div {
            background: white;
            margin: 50px auto;
            padding: 24px;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
<div class="header">
    <h2>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
    <div>
        <span id="userInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        <button class="btn btn-danger" id="logoutBtn">–í—ã–π—Ç–∏</button>
    </div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∏ -->
<div class="tabs">
    <button class="tab-btn active" data-tab="crud">–ü—Ä–æ—Å–º–æ—Ç—Ä/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ –ë–î</button>
    <button class="tab-btn" data-tab="reports">–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏</button>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞ 1: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π CRUD -->
<div id="crud" class="tab-content active">
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü</h3>
    <div class="form-group">
        <label for="tableSelect">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É</label>
        <select id="tableSelect">
            <option value="">‚Äî –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü ‚Äî</option>
        </select>
    </div>
    <button class="btn" id="addRecordBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
    <div id="tableContainer">
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É</p>
    </div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞ 2: –û—Ç—á—ë—Ç—ã -->
<div id="reports" class="tab-content">
    <h3>–û—Ç—á—ë—Ç—ã</h3>

    <div style="margin-bottom: 24px; padding: 16px; border: 1px solid #eee; border-radius: 8px;">
        <h4>–í—ã—Ä—É—á–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º</h4>
        <p>–ê–Ω–∞–ª–∏–∑ –¥–æ—Ö–æ–¥–æ–≤ –æ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å—è—Ü–µ–≤.</p>
        <div>
            <button class="btn" id="exportRevenueExcel">üìÑ Excel</button>
            <button class="btn" id="exportRevenueWord">üìù Word</button>
        </div>
    </div>

    <!-- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –¥—Ä—É–≥–∏—Ö –æ—Ç—á—ë—Ç–æ–≤ -->
    <div style="margin-bottom: 24px; padding: 16px; border: 1px solid #eee; border-radius: 8px;">
        <h4>–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ä–µ–π—Å—ã</h4>
        <p>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º –≥—Ä—É–∑–∞–º.</p>
        <div>
            <button class="btn" disabled>üìÑ Excel</button>
            <button class="btn" disabled>üìù Word</button>
        </div>
    </div>

    <div style="margin-bottom: 24px; padding: 16px; border: 1px solid #eee; border-radius: 8px;">
        <h4>–ù–∞—Ä—É—à–µ–Ω–∏—è –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º</h4>
        <p>–†–µ–π—Ç–∏–Ω–≥ –≤–æ–¥–∏—Ç–µ–ª–µ–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –î–¢–ü –∏ —à—Ç—Ä–∞—Ñ–æ–≤.</p>
        <div>
            <button class="btn" disabled>üìÑ Excel</button>
            <button class="btn" disabled>üìù Word</button>
        </div>
    </div>

    <div style="margin-bottom: 24px; padding: 16px; border: 1px solid #eee; border-radius: 8px;">
        <h4>–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞</h4>
        <p>–ê–Ω–∞–ª–∏–∑ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ —Ç–æ–ø–ª–∏–≤–æ –ø–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É –∏ –º–∞—Ä—à—Ä—É—Ç–∞–º.</p>
        <div>
            <button class="btn" disabled>üìÑ Excel</button>
            <button class="btn" disabled>üìù Word</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ CRUD -->
<div id="universalCrudModal">
    <div>
        <h3 id="crudModalTitle">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h3>
        <form id="crudForm">
            <input type="hidden" id="crudRecordId" />
            <div id="crudFormFields"></div>
            <div style="margin-top: 16px;">
                <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" id="cancelCrudBtn" class="btn" style="background:#ccc;">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>
    </div>
</div>

<script>
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
    window.electronAPI.setWindowSize(1100, 800);

    let currentAdmin = null;
    let currentTable = null;
    let tableSchema = [];

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            const user = await window.electronAPI.getCurrentUser();
            if (user && user.role === 'admin') {
                currentAdmin = user;
                document.getElementById('userInfo').textContent = `${user.lastName} ${user.firstName} (–∞–¥–º–∏–Ω)`;
                loadTableList();
            } else {
                window.location.href = '../login.html';
            }
        } catch (err) {
            console.error(err);
            alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
        }
    });
    // üî• –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–û–ï –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –í–ö–õ–ê–î–û–ö
    document.addEventListener('DOMContentLoaded', () => {
        const tabButtons = document.querySelectorAll('.tab-btn');
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // –£–±–∏—Ä–∞–µ–º active —É –≤—Å–µ—Ö
                tabButtons.forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                // –î–æ–±–∞–≤–ª—è–µ–º active —Ç–µ–∫—É—â–µ–π
                button.classList.add('active');
                const tabId = button.dataset.tab;
                document.getElementById(tabId).classList.add('active');

                // –û—Å–æ–±–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ CRUD
                if (tabId === 'crud' && !currentTable) {
                    loadTableList();
                }
            });
        });
    });
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç–∞–±–ª–∏—Ü
    async function loadTableList() {
        const select = document.getElementById('tableSelect');
        select.innerHTML = '<option value="">‚Äî –ó–∞–≥—Ä—É–∑–∫–∞... ‚Äî</option>';
        try {
            const res = await window.electronAPI.getAdminTables();
            if (!res.success) throw new Error(res.message);

            select.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É ‚Äî</option>';
            res.tables.forEach(table => {
                const opt = document.createElement('option');
                opt.value = table;
                opt.textContent = table;
                select.appendChild(opt);
            });
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü:', err);
            select.innerHTML = '<option value="">–û—à–∏–±–∫–∞</option>';
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü—ã
    async function loadTableData(tableName) {
        const container = document.getElementById('tableContainer');
        container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>';

        try {
            const schemaRes = await window.electronAPI.getTableSchema(tableName);
            if (!schemaRes.success) throw new Error(schemaRes.message);
            tableSchema = schemaRes.schema;

            const dataRes = await window.electronAPI.getTableData(tableName);
            if (!dataRes.success) throw new Error(dataRes.message);
            const data = dataRes.data;

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
            const thead = document.createElement('thead');
            thead.innerHTML = `<tr>${tableSchema.map(col => `<th>${col.column_name}</th>`).join('')}</tr>`;

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä–æ–∫
            const tbody = document.createElement('tbody');
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${tableSchema.length}">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
            } else {
                tbody.innerHTML = data.map(row => {
                    const cells = tableSchema.map(col => {
                        const value = row[col.column_name];
                        if (value === null) return '<em>null</em>';
                        if (typeof value === 'object') return JSON.stringify(value);
                        return String(value);
                    }).join('</td><td>');
                    return `<tr data-id="${row[tableSchema[0].column_name]}"><td>${cells}</td><td>
              <button class="btn edit-btn" data-id="${row[tableSchema[0].column_name]}">‚úèÔ∏è</button>
              <button class="btn btn-danger delete-btn" data-id="${row[tableSchema[0].column_name]}">üóëÔ∏è</button>
            </td></tr>`;
                }).join('');
            }

            const table = document.createElement('table');
            table.id = 'dataTable';
            table.appendChild(thead);
            table.appendChild(tbody);
            container.innerHTML = '';
            container.appendChild(table);

            currentTable = tableName;
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', err);
            container.innerHTML = `<p>–û—à–∏–±–∫–∞: ${err.message}</p>`;
        }
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
    document.getElementById('tableSelect').addEventListener('change', (e) => {
        const tableName = e.target.value;
        if (tableName) {
            loadTableData(tableName);
        } else {
            document.getElementById('tableContainer').innerHTML = '<p>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É</p>';
        }
    });

    // –û—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    document.getElementById('addRecordBtn').addEventListener('click', () => {
        if (!currentTable) {
            alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É');
            return;
        }
        openCrudForm('add');
    });

    // –û—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    document.getElementById('tableContainer').addEventListener('click', (e) => {
        if (e.target.classList.contains('edit-btn')) {
            const id = e.target.dataset.id;
            openCrudForm('edit', id);
        }
        if (e.target.classList.contains('delete-btn')) {
            const id = e.target.dataset.id;
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) {
                deleteRecord(id);
            }
        }
    });

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function openCrudForm(mode, id = null) {
        document.getElementById('crudRecordId').value = id || '';
        document.getElementById('crudModalTitle').textContent = mode === 'add' ? '–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å';
        generateFormFields(mode, id);
        document.getElementById('universalCrudModal').style.display = 'block';
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
    function generateFormFields(mode, id) {
        const container = document.getElementById('crudFormFields');
        container.innerHTML = '';

        tableSchema.forEach(col => {
            // –ù–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏
            if (mode === 'add' && isPrimaryKey(col)) return;

            const label = document.createElement('label');
            label.textContent = col.column_name;
            label.style.display = 'block';
            label.style.marginBottom = '6px';

            const input = document.createElement('input');
            input.name = col.column_name;
            input.style.width = '100%';
            input.style.padding = '8px';

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–æ–ª—è
            if (col.data_type === 'boolean') {
                input.type = 'checkbox';
                input.style.width = 'auto';
            } else if (col.data_type.includes('int') || col.data_type === 'numeric') {
                input.type = 'number';
                input.step = 'any';
            } else if (col.data_type.includes('timestamp')) {
                input.type = 'datetime-local';
            } else {
                input.type = 'text';
            }

            // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –∑–∞–ø–æ–ª–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
            if (mode === 'edit') {
                // –ó–Ω–∞—á–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            }

            const div = document.createElement('div');
            div.className = 'form-group';
            div.appendChild(label);
            div.appendChild(input);
            container.appendChild(div);
        });
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
    async function deleteRecord(id) {
        try {
            const res = await window.electronAPI.deleteTableRecord(currentTable, id);
            if (res.success) {
                alert('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞');
                loadTableData(currentTable);
            } else {
                alert(res.message);
                loadTableData(currentTable);
            }
        } catch (err) {
            alert(err.message);
            loadTableData(currentTable);
        }
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
    document.getElementById('crudForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('crudRecordId').value;
        const formData = new FormData(e.target);
        const data = {};
        for (let [key, value] of formData.entries()) {
            if (tableSchema.find(col => col.column_name === key)?.data_type === 'boolean') {
                data[key] = value === 'on';
            } else if (value === '') {
                data[key] = null;
            } else {
                data[key] = value;
            }
        }

        try {
            let res;
            if (id) {
                res = await window.electronAPI.updateTableRecord(currentTable, id, data);
            } else {
                res = await window.electronAPI.createTableRecord(currentTable, data);
            }
            if (res.success) {
                alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
                document.getElementById('universalCrudModal').style.display = 'none';
                loadTableData(currentTable);
            } else {
                alert(res.message);
                loadTableData(currentTable);
            }
        } catch (err) {
            alert(err.message);
        }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('cancelCrudBtn').addEventListener('click', () => {
        document.getElementById('universalCrudModal').style.display = 'none';
    });

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
    function isPrimaryKey(column) {
        // –£–ø—Ä–æ—â—ë–Ω–Ω–æ: —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á ‚Äî –ø–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü —Å –∏–º–µ–Ω–µ–º *id
        return column.column_name.toLowerCase().endsWith('id');
    }

    // –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
    document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('–í—ã–π—Ç–∏?')) {
            await window.electronAPI.logout();
            window.electronAPI.openLoginWindow();
            window.close();
        }
    });
    // –≠–∫—Å–ø–æ—Ä—Ç –≤—ã—Ä—É—á–∫–∏
    document.getElementById('exportRevenueExcel').addEventListener('click', async () => {
        try {
            const res = await window.electronAPI.exportRevenueToExcel();
            if (res.success) {
                alert(`‚úÖ –û—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω:\n${res.filePath}`);
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + res.message);
            }
        } catch (err) {
            alert('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + err.message);
        }
    });

    document.getElementById('exportRevenueWord').addEventListener('click', async () => {
        try {
            const res = await window.electronAPI.exportRevenueToWord();
            if (res.success) {
                alert(`‚úÖ –û—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω:\n${res.filePath}`);
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + res.message);
            }
        } catch (err) {
            alert('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + err.message);
        }
    });
</script>
</body>
</html>